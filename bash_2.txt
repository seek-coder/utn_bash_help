#!/bin/bash

echo
echo "Para ejecutar:   ./<tu-apellido>_check_URL.sh  <Path_Repo>/202407/bash_script/Lista_URL.txt"
echo

LISTA=$1

echo "archivo=$LISTA"

ANT_IFS=$IFS
IFS=$'\n'

# Create directory structure
BASE_DIR="/tmp/head-check"
ERROR_DIR="$BASE_DIR/Error"
LOG_FILE="/var/log/status_URL.log"

mkdir -p "$ERROR_DIR/cliente"
mkdir -p "$ERROR_DIR/servidor"
mkdir -p "$BASE_DIR/ok"

for line in $(cat "$LISTA" | grep -v ^#); do
  DOMAIN=$(echo "$line" | awk '{print $1}')
  URL=$(echo "$line" | awk '{print $2}')

  STATUS_CODE=$(curl -LI -o /dev/null -w '%{http_code}\n' -s "$URL")

  TIMESTAMP=$(date +%Y%m%d_%H%M%S)
  LOG_ENTRY="$TIMESTAMP - Code:$STATUS_CODE - URL:$URL"

  echo "$LOG_ENTRY" >> "$LOG_FILE"

  if [[ "$STATUS_CODE" -eq 200 ]]; then
    DIRECTORY="ok"
  elif [[ "$STATUS_CODE" -ge 400 && "$STATUS_CODE" -le 499 ]]; then
    DIRECTORY="Error/cliente"
  elif [[ "$STATUS_CODE" -ge 500 && "$STATUS_CODE" -le 599 ]]; then
    DIRECTORY="Error/servidor"
  else
    DIRECTORY="Error"
  fi

  echo "$LOG_ENTRY" >> "$BASE_DIR/$DIRECTORY/$DOMAIN.log"

done

IFS=$ANT_IFS
